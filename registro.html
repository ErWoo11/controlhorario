<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro de Obra</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    h2 { text-align: center; color: #2c3e50; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, button {
      width: 100%; padding: 12px; margin-top: 8px; font-size: 16px;
    }
    button { background: #2ecc71; color: white; border: none; border-radius: 6px; cursor: pointer; }
    #salida { background: #e74c3c; }
    #mensaje {
      margin-top: 20px; padding: 12px; text-align: center; border-radius: 6px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    #cargando { color: #3498db; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Registro de Jornada</h2>

    <div id="cargando">Cargando lista de trabajadores...</div>
    <div id="formulario" style="display:none;">
      <label for="pin">Introduce tu PIN (4 dÃ­gitos):</label>
      <input type="number" id="pin" placeholder="Ej: 1234" min="1000" max="9999" />
      <button id="entrada">âœ… Registrar ENTRADA</button>
      <button id="salida">ðŸšª Registrar SALIDA</button>
    </div>

    <div id="mensaje"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyACVAm_3qDdghFNixYIYF6ToYOf_dIVodE",
      authDomain: "control-horario-obra.firebaseapp.com",
      projectId: "control-horario-obra",
      storageBucket: "control-horario-obra.firebasestorage.app",
      messagingSenderId: "566402636945",
      appId: "1:566402636945:web:7a8fa39c373ae62a49b330"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let TRABAJADORES = {};

    function mostrarMensaje(texto, tipo = 'success') {
      const msg = document.getElementById('mensaje');
      msg.textContent = texto;
      msg.className = tipo;
    }

    async function cargarTrabajadores() {
      try {
        const snapshot = await db.collection('trabajadores').get();
        const mapa = {};
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.pin && data.nombre) {
            mapa[data.pin] = data.nombre;
          }
        });
        TRABAJADORES = mapa;
        document.getElementById('cargando').style.display = 'none';
        document.getElementById('formulario').style.display = 'block';
      } catch (err) {
        console.error("Error al cargar trabajadores:", err);
        mostrarMensaje('âŒ Error al cargar la lista.', 'error');
      }
    }

    async function obtenerUltimoTipo(pin) {
      const snapshot = await db.collection('registros_publicos')
        .where('trabajadorId', '==', pin)
        .orderBy('fechaHora', 'desc')
        .limit(1)
        .get();
      if (snapshot.empty) return null;
      return snapshot.docs[0].data().tipo;
    }

    async function registrar(tipo) {
      const pinInput = document.getElementById('pin');
      const pin = pinInput.value.trim();

      if (!pin || !TRABAJADORES[pin]) {
        mostrarMensaje('âš ï¸ PIN no vÃ¡lido', 'error');
        return;
      }

      try {
        const ultimoTipo = await obtenerUltimoTipo(pin);

        if (tipo === 'entrada' && ultimoTipo === 'entrada') {
          mostrarMensaje('âŒ Ya registraste una entrada. Debes registrar SALIDA primero.', 'error');
          return;
        }
        if (tipo === 'salida' && ultimoTipo === 'salida') {
          mostrarMensaje('âŒ Ya registraste una salida. Debes registrar ENTRADA primero.', 'error');
          return;
        }

        await db.collection('registros_publicos').add({
          trabajadorId: pin,
          nombre: TRABAJADORES[pin],
          tipo: tipo,
          fechaHora: firebase.firestore.FieldValue.serverTimestamp()
        });

        mostrarMensaje(`âœ… ${tipo === 'entrada' ? 'Entrada' : 'Salida'} registrada para ${TRABAJADORES[pin]}`, 'success');
        pinInput.value = '';
      } catch (err) {
        console.error("Error al registrar:", err);
        if (err.code === 'failed-precondition') {
          mostrarMensaje('âŒ Error: falta Ã­ndice en Firestore. Contacta al administrador.', 'error');
        } else {
          mostrarMensaje('âŒ Error: ' + (err.message || 'conexiÃ³n'), 'error');
        }
      }
    }

    cargarTrabajadores();
    document.getElementById('entrada').addEventListener('click', () => registrar('entrada'));
    document.getElementById('salida').addEventListener('click', () => registrar('salida'));
  </script>
</body>
</html>