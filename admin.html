<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Control Horario</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; margin: 0; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    h2, h3 { color: #2c3e50; text-align: center; }
    input, button { width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; box-sizing: border-box; }
    button { background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; }
    #logout { background: #e74c3c; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #f2f2f2; }
    #datos, #login, #gestion-trabajadores { margin-top: 20px; }
    .hidden { display: none; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab-btn { flex: 1; background: #bdc3c7; cursor: pointer; font-weight: bold; }
    .tab-btn.active { background: #3498db; color: white; }
    .msg { padding: 8px; margin: 10px 0; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Panel de Administraci√≥n</h2>

    <!-- Login -->
    <div id="login">
      <p>Inicia sesi√≥n para acceder.</p>
      <input type="email" id="email" placeholder="Tu email" />
      <input type="password" id="password" placeholder="Contrase√±a" />
      <button id="btn-login">üîê Iniciar sesi√≥n</button>
      <div id="msg-login"></div>
    </div>

    <!-- Panel principal -->
    <div id="datos" class="hidden">
      <p>Bienvenido, <span id="user-email"></span> | <button id="logout">Cerrar sesi√≥n</button></p>

      <!-- Pesta√±as -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="registros">Registros</button>
        <button class="tab-btn" data-tab="trabajadores">Gesti√≥n de Trabajadores</button>
      </div>

      <!-- Registros -->
      <div id="tab-registros">
        <button id="cargar">‚Üª Cargar registros</button>
        <button id="borrar-registros">üóëÔ∏è Borrar todos los registros</button>
        <button id="exportar">üì• Exportar a Excel</button>
        <table>
          <thead><tr><th>Nombre</th><th>Tipo</th><th>Fecha y Hora</th></tr></thead>
          <tbody id="tabla-cuerpo"></tbody>
        </table>
      </div>

      <!-- Trabajadores -->
      <div id="tab-trabajadores" class="hidden">
        <h3>Gesti√≥n de Trabajadores</h3>
        <input type="text" id="nuevo-pin" placeholder="PIN (4 d√≠gitos)" maxlength="4" />
        <input type="text" id="nuevo-nombre" placeholder="Nombre completo" />
        <button id="btn-agregar">‚ûï A√±adir trabajador</button>
        <div id="msg-trabajadores"></div>
        <table id="tabla-trabajadores">
          <thead><tr><th>PIN</th><th>Nombre</th><th>Acci√≥n</th></tr></thead>
          <tbody id="cuerpo-trabajadores"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <script>
    // üîë Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyACVAm_3qDdghFNixYIYF6ToYOf_dIVodE",
      authDomain: "control-horario-obra.firebaseapp.com",
      projectId: "control-horario-obra",
      storageBucket: "control-horario-obra.firebasestorage.app",
      messagingSenderId: "566402636945",
      appId: "1:566402636945:web:7a8fa39c373ae62a49b330"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Elementos del DOM
    const loginDiv = document.getElementById('login');
    const datosDiv = document.getElementById('datos');
    const userEmailSpan = document.getElementById('user-email');

    // ‚úÖ AUTENTICACI√ìN: se registra inmediatamente
    auth.onAuthStateChanged(user => {
      if (user) {
        loginDiv.classList.add('hidden');
        datosDiv.classList.remove('hidden');
        userEmailSpan.textContent = user.email;
        cargarRegistros();
      } else {
        loginDiv.classList.remove('hidden');
        datosDiv.classList.add('hidden');
      }
    });

    // Formatear fecha
    function formatearFecha(fecha) {
      if (fecha?.toDate) fecha = fecha.toDate();
      return new Intl.DateTimeFormat('es-ES', {
        year: '2-digit',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      }).format(fecha);
    }

    // --- FUNCIONES DE REGISTROS ---
    async function cargarRegistros() {
      const cuerpo = document.getElementById('tabla-cuerpo');
      cuerpo.innerHTML = '<tr><td colspan="3">Cargando...</td></tr>';
      try {
        const snapshot = await db.collection('registros_publicos')
          .orderBy('fechaHora', 'desc')
          .limit(500)
          .get();

        const filas = [];
        const datos = [];
        snapshot.forEach(doc => {
          const r = doc.data();
          datos.push(r);
          filas.push(`<tr><td>${r.nombre}</td><td>${r.tipo}</td><td>${formatearFecha(r.fechaHora)}</td></tr>`);
        });
        cuerpo.innerHTML = filas.join('');
        window.datosExportar = datos;
      } catch (err) {
        cuerpo.innerHTML = '<tr><td colspan="3">Error al cargar</td></tr>';
        console.error(err);
      }
    }

    async function borrarTodosRegistros() {
      if (!confirm("‚ö†Ô∏è ¬øEst√°s seguro? Esto borrar√° TODOS los registros de jornada.")) return;
      if (!confirm("üî¥ ¬°CONFIRMACI√ìN FINAL! ¬øBorrar todos los registros?")) return;

      try {
        const snapshot = await db.collection('registros_publicos').get();
        const batch = db.batch();
        snapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        alert('‚úÖ Todos los registros han sido eliminados.');
        cargarRegistros();
      } catch (err) {
        alert('‚ùå Error al borrar: ' + err.message);
        console.error(err);
      }
    }

    // --- EXPORTAR A EXCEL (solo si SheetJS est√° disponible) ---
    async function exportarExcel(datos) {
      if (!window.XLSX) {
        // Cargar SheetJS din√°micamente
        const script = document.createElement('script');
        script.src = 'https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js';
        script.onload = () => exportarConSheetJS(datos);
        script.onerror = () => alert('‚ùå No se pudo cargar la librer√≠a de Excel.');
        document.head.appendChild(script);
      } else {
        exportarConSheetJS(datos);
      }
    }

    function exportarConSheetJS(datos) {
      const XLSX = window.XLSX;
      const registros = datos.map(r => ({
        Nombre: r.nombre,
        Tipo: r.tipo,
        'Fecha y Hora': formatearFecha(r.fechaHora)
      }));

      const ws1 = XLSX.utils.json_to_sheet(registros);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws1, "Registros");

      const trabajadores = {};
      datos.forEach(r => {
        if (!trabajadores[r.nombre]) trabajadores[r.nombre] = [];
        trabajadores[r.nombre].push({
          tipo: r.tipo,
          fecha: r.fechaHora.toDate ? r.fechaHora.toDate() : new Date(r.fechaHora)
        });
      });

      const computo = [];
      for (const nombre in trabajadores) {
        const eventos = trabajadores[nombre].sort((a, b) => a.fecha - b.fecha);
        let totalMs = 0;
        let ultimaEntrada = null;
        for (const ev of eventos) {
          if (ev.tipo === 'entrada') ultimaEntrada = ev.fecha;
          else if (ev.tipo === 'salida' && ultimaEntrada) {
            totalMs += ev.fecha - ultimaEntrada;
            ultimaEntrada = null;
          }
        }
        const totalHoras = totalMs / (1000 * 60 * 60);
        computo.push({ Nombre: nombre, 'Horas totales': parseFloat(totalHoras.toFixed(2)) });
      }

      const ws2 = XLSX.utils.json_to_sheet(computo);
      XLSX.utils.book_append_sheet(wb, ws2, "C√≥mputo horas");
      XLSX.writeFile(wb, "registros_horario.xlsx");
    }

    // --- GESTI√ìN DE TRABAJADORES ---
    async function cargarTrabajadores() {
      const cuerpo = document.getElementById('cuerpo-trabajadores');
      cuerpo.innerHTML = '<tr><td colspan="3">Cargando...</td></tr>';
      try {
        const snapshot = await db.collection('trabajadores').get();
        const filas = [];
        const lista = {};
        snapshot.forEach(doc => {
          const data = doc.data();
          lista[doc.id] = { id: doc.id, pin: data.pin, nombre: data.nombre };
          filas.push(`
            <tr>
              <td>${data.pin}</td>
              <td>${data.nombre}</td>
              <td>
                <button onclick="editarTrabajador('${doc.id}', '${data.pin.replace(/'/g, "\\'")}', '${data.nombre.replace(/'/g, "\\'")}')" style="margin-right:5px;">‚úèÔ∏è</button>
                <button onclick="eliminarTrabajador('${doc.id}')">üóëÔ∏è</button>
              </td>
            </tr>
          `);
        });
        window.listaTrabajadores = lista;
        cuerpo.innerHTML = filas.join('');
      } catch (err) {
        cuerpo.innerHTML = '<tr><td colspan="3">Error</td></tr>';
        console.error(err);
      }
    }

    async function agregarTrabajador() {
      const pin = document.getElementById('nuevo-pin').value.trim();
      const nombre = document.getElementById('nuevo-nombre').value.trim();
      const msg = document.getElementById('msg-trabajadores');

      if (!pin || !nombre || pin.length !== 4 || isNaN(pin)) {
        msg.textContent = '‚ö†Ô∏è PIN debe ser 4 d√≠gitos y nombre obligatorio.';
        msg.className = 'error';
        return;
      }

      const yaExiste = Object.values(window.listaTrabajadores || {}).some(t => 
        t.pin === pin || t.nombre === nombre
      );
      if (yaExiste) {
        msg.textContent = '‚ùå PIN o nombre ya existen.';
        msg.className = 'error';
        return;
      }

      try {
        await db.collection('trabajadores').add({ pin, nombre });
        msg.textContent = '‚úÖ Trabajador a√±adido.';
        msg.className = 'success';
        document.getElementById('nuevo-pin').value = '';
        document.getElementById('nuevo-nombre').value = '';
        cargarTrabajadores();
      } catch (err) {
        msg.textContent = '‚ùå Error: ' + err.message;
        msg.className = 'error';
        console.error(err);
      }
    }

    // Funciones globales para botones
    window.eliminarTrabajador = async (id) => {
      if (!confirm('¬øEliminar este trabajador?')) return;
      try {
        await db.collection('trabajadores').doc(id).delete();
        cargarTrabajadores();
      } catch (err) {
        alert('Error al eliminar.');
        console.error(err);
      }
    };

    window.editarTrabajador = (id, pin, nombre) => {
      const nuevoPin = prompt("Editar PIN (4 d√≠gitos):", pin);
      const nuevoNombre = prompt("Editar nombre:", nombre);
      
      if (nuevoPin === null || nuevoNombre === null) return;
      if (!nuevoPin || !nuevoNombre || nuevoPin.length !== 4 || isNaN(nuevoPin)) {
        alert("‚ö†Ô∏è PIN debe ser 4 d√≠gitos.");
        return;
      }

      const duplicado = Object.values(window.listaTrabajadores || {}).some(t => 
        t.id !== id && (t.pin === nuevoPin || t.nombre === nuevoNombre)
      );
      if (duplicado) {
        alert("‚ùå PIN o nombre ya existen.");
        return;
      }

      db.collection('trabajadores').doc(id).update({ pin: nuevoPin, nombre: nuevoNombre })
        .then(() => {
          alert("‚úÖ Trabajador actualizado.");
          cargarTrabajadores();
        })
        .catch(err => {
          alert("‚ùå Error: " + err.message);
        });
    };

    // --- PESTA√ëAS ---
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        document.getElementById('tab-registros').classList.toggle('hidden', tab !== 'registros');
        document.getElementById('tab-trabajadores').classList.toggle('hidden', tab !== 'trabajadores');
        if (tab === 'trabajadores') cargarTrabajadores();
      });
    });

    // --- EVENTOS DE BOTONES ---
    document.getElementById('btn-login').addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const msg = document.getElementById('msg-login');
      if (!email || !password) {
        msg.textContent = 'Introduce email y contrase√±a';
        msg.className = 'error';
        return;
      }
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (err) {
        msg.textContent = 'Error: ' + err.message;
        msg.className = 'error';
      }
    });

    document.getElementById('logout').addEventListener('click', () => auth.signOut());
    document.getElementById('cargar').addEventListener('click', cargarRegistros);
    document.getElementById('borrar-registros').addEventListener('click', borrarTodosRegistros);
    document.getElementById('exportar').addEventListener('click', () => {
      if (window.datosExportar?.length) exportarExcel(window.datosExportar);
      else alert('No hay datos para exportar.');
    });
    document.getElementById('btn-agregar').addEventListener('click', agregarTrabajador);

    // Cargar registros al inicio (por si hay usuario logueado)
    cargarRegistros();
  </script>
</body>
</html>